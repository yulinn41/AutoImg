<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8" />
<title>WS åœ–ç‰‡æ¸¬è©¦é€å‡ºå™¨</title>
<style>
  body { font-family: sans-serif; padding: 20px; max-width: 520px; }
  label { display: block; margin-top: 12px; }
  input { width: 100%; padding: 6px; margin-top: 4px; }
  button { margin-top: 16px; padding: 10px; width: 100%; font-size: 16px; }
  #log { margin-top: 16px; font-size: 14px; white-space: pre-line; }
</style>
</head>
<body>

<h2>WS åœ–ç‰‡å£“åŠ›æ¸¬è©¦é€å‡ºå™¨</h2>

<label>WebSocket Server URL
  <input id="wsUrl" value="ws://localhost:8081">
</label>

<label>åœ–ç‰‡å¯¬åº¦ (px)
  <input id="imgWidth" type="number" value="1560">
</label>

<label>åœ–ç‰‡é«˜åº¦ (px)
  <input id="imgHeight" type="number" value="520">
</label>

<label>å‚³é€å¼µæ•¸
  <input id="count" type="number" value="10">
</label>

<label>æ¯å¹¾ç§’é€ä¸€å¼µ
  <input id="interval" type="number" step="0.1" value="0.5">
</label>

<button onclick="start()">â–¶ é–‹å§‹é€å‡º</button>

<div id="log">ç‹€æ…‹ï¼šæœªé€£ç·š</div>

<script>
let ws;
let stopped = false;

function log(msg) {
  const el = document.getElementById("log");
  el.textContent += msg + "\n";
}

async function start() {
  stopped = false;
  document.getElementById("log").textContent = "";

  const wsUrl = document.getElementById("wsUrl").value;
  const w = +document.getElementById("imgWidth").value;
  const h = +document.getElementById("imgHeight").value;
  const count = +document.getElementById("count").value;
  const interval = +document.getElementById("interval").value * 1000;

  ws = new WebSocket(wsUrl);
  ws.binaryType = "arraybuffer";

  ws.onopen = async () => {
    log("âœ… WS å·²é€£ç·š");

    for (let i = 0; i < count && !stopped; i++) {
      const id = `img__${i}__classic`;

      // 1ï¸âƒ£ HEADER
      ws.send(JSON.stringify({
        type: "HEADER",
        id: id,
        meta: { style: "classic" }
      }));
      log(`ğŸ“© HEADER ${id}`);

      // 2ï¸âƒ£ Binary PNG
      const png = await generatePng(w, h, i);
      ws.send(png);
      log(`ğŸ“¤ Binary ${i}`);

      await sleep(interval);
    }

    log("âœ… å‚³é€å®Œæˆ");
  };

  ws.onmessage = (e) => {
    try {
      const msg = JSON.parse(e.data);
      if (msg.type === "UPLOAD_OK") {
        log(`âœ” Server ACK id=${msg.id}`);
      }
      if (msg.type === "UNITY_STATUS") {
        log(`ğŸ® Unity connected = ${msg.connected}`);
      }
    } catch {}
  };

  ws.onerror = () => log("âŒ WS error");
  ws.onclose = () => log("ğŸ”Œ WS closed");
}

function stop() {
  stopped = true;
  if (ws) ws.close();
}

function generatePng(width, height, number) {
  return new Promise(resolve => {
    const canvas = document.createElement("canvas");
    canvas.width = width;
    canvas.height = height;
    const ctx = canvas.getContext("2d");

    ctx.fillStyle = "#444";
    ctx.fillRect(0, 0, width, height);

    ctx.fillStyle = "#fff";
    ctx.font = `${Math.floor(height * 0.6)}px Arial`;
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.fillText(number.toString(), width / 2, height / 2);

    canvas.toBlob(blob => {
      blob.arrayBuffer().then(buf => resolve(buf));
    }, "image/png");
  });
}

function sleep(ms) {
  return new Promise(r => setTimeout(r, ms));
}
</script>

</body>
</html>
